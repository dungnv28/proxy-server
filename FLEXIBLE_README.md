# Flexible Dual Proxy Manager v4.0

H·ªá th·ªëng qu·∫£n l√Ω proxy linh ho·∫°t v·ªõi **KI·ªÇM SO√ÅT BƒÇNG TH√îNG KHI C·∫¶N** - cung c·∫•p c·∫£ HTTP (Squid) v√† SOCKS5 (Dante) v·ªõi ƒë·∫ßy ƒë·ªß c√°c thao t√°c CRUD, gi·ªõi h·∫°n t·ªëc ƒë·ªô v√† quota khi mu·ªën.

## üöÄ T√çNH NƒÇNG CH√çNH - LINH HO·∫†T HO√ÄN TO√ÄN

### ‚ö° **Gi·ªõi h·∫°n t·ªëc ƒë·ªô KHI C·∫¶N**
- **M·∫∑c ƒë·ªãnh: UNLIMITED** cho t·∫•t c·∫£ proxy m·ªõi
- **Gi·ªõi h·∫°n khi mu·ªën**: C√≥ th·ªÉ set speed limit b·∫•t c·ª© l√∫c n√†o
- **C√πng gi√° tr·ªã Up/Down**: 100Mbps = 100Mbps up + 100Mbps down
- **√Åp d·ª•ng cho c·∫£ HTTP v√† SOCKS5** c·ªßa c√πng user

### üìä **Qu·∫£n l√Ω Quota KHI C·∫¶N**
- **M·∫∑c ƒë·ªãnh: UNLIMITED** cho t·∫•t c·∫£ proxy m·ªõi
- **Gi·ªõi h·∫°n khi mu·ªën**: Set total quota b·∫•t c·ª© l√∫c n√†o (kh√¥ng theo th√°ng)
- **T·ª± ƒë·ªông ch·∫∑n** khi h·∫øt quota
- **Reset quota** th·ªß c√¥ng khi c·∫ßn

### üéØ **Tri·∫øt l√Ω: "Th√≠ch th√¨ gi·ªõi h·∫°n th√¥i!"**
- **Kh√¥ng b·∫Øt bu·ªôc** theo th√°ng hay chu k·ª≥ n√†o
- **T·ª± do** set limit khi c·∫ßn cho kinh doanh
- **Linh ho·∫°t** thay ƒë·ªïi b·∫•t c·ª© l√∫c n√†o
- **ƒê∆°n gi·∫£n** v√† th·ª±c t·∫ø

## üîß WORKFLOW S·ª¨ D·ª§NG

### üéØ **T·∫°o Proxy M·ªõi**
```bash
sudo ./flexible-dual-proxy.sh

# Ch·ªçn option 1: Create Single Proxy Pair
# H·ªá th·ªëng h·ªèi:

Bandwidth Configuration:
1) Unlimited (default)    ‚Üê Ch·ªçn n√†y n·∫øu mu·ªën unlimited
2) Custom speed limit and total quota    ‚Üê Ch·ªçn n√†y n·∫øu mu·ªën gi·ªõi h·∫°n

# N·∫øu ch·ªçn 1: T·∫°o proxy unlimited ho√†n to√†n
# N·∫øu ch·ªçn 2: Nh·∫≠p speed (Mbps) v√† quota (GB)
```

### üîÑ **Thay ƒë·ªïi sau khi t·∫°o**
```bash
# V√†o menu qu·∫£n l√Ω
sudo ./flexible-dual-proxy.sh menu

# Ch·ªçn option 4: Update Proxy Bandwidth Settings
# C√≥ th·ªÉ:
1) Ch·ªâ thay ƒë·ªïi speed limit
2) Ch·ªâ thay ƒë·ªïi quota
3) Thay ƒë·ªïi c·∫£ hai
4) Reset v·ªÅ unlimited
5) Block/Unblock user
```

## üìã MENU QU·∫¢N L√ù LINH HO·∫†T

```
Flexible Proxy Management Menu
Server: 192.168.1.100 | HTTP: 3128 | SOCKS5: 1080

CRUD Operations:
1) Create Single Proxy Pair (with Bandwidth Control)
2) Create Multiple Proxy Pairs (with Bandwidth Control)  
3) Read/List All Proxy Pairs (with Bandwidth Info)
4) Update Proxy Bandwidth Settings
5) Delete Single Proxy Pair
6) Delete All Proxy Pairs

Bandwidth Management:
7) Show Bandwidth Statistics
8) Monitor Bandwidth Usage (Real-time)
9) Reset User Quota

System Management:
10) Export Proxy Pairs
11) Test Proxy Pair
12) Service Status
13) Restart Services
14) View Logs

0) Exit
```

## üéØ V√ç D·ª§ S·ª¨ D·ª§NG TH·ª∞C T·∫æ

### **Scenario 1: T·∫°o proxy unlimited (m·∫∑c ƒë·ªãnh)**
```bash
# T·∫°o proxy m·ªõi
1) Create Single Proxy Pair

Bandwidth Configuration:
1) Unlimited (default)    ‚Üê Ch·ªçn 1
2) Custom speed limit and total quota

# K·∫øt qu·∫£:
‚úì Proxy pair created successfully!
HTTP Proxy:   192.168.1.100:3128:proxy_a1b2c3d4:pass_x9y8z7w6
SOCKS5 Proxy: 192.168.1.100:1080:proxy_a1b2c3d4:pass_x9y8z7w6
Speed Limit:  Unlimited
Total Quota:  Unlimited
```

### **Scenario 2: Kh√°ch h√†ng mu·ªën mua g√≥i c√≥ gi·ªõi h·∫°n**
```bash
# T·∫°o proxy v·ªõi gi·ªõi h·∫°n
1) Create Single Proxy Pair

Bandwidth Configuration:
1) Unlimited (default)
2) Custom speed limit and total quota    ‚Üê Ch·ªçn 2

Enter speed limit in Mbps (0 for unlimited): 100
Enter total quota in GB (0 for unlimited): 50

# K·∫øt qu·∫£:
‚úì Proxy pair created successfully!
HTTP Proxy:   192.168.1.100:3128:proxy_e5f6g7h8:pass_m3n4o5p6
SOCKS5 Proxy: 192.168.1.100:1080:proxy_e5f6g7h8:pass_m3n4o5p6
Speed Limit:  100Mbps
Total Quota:  50GB
```

### **Scenario 3: Kh√°ch h√†ng mu·ªën upgrade**
```bash
# Update proxy hi·ªán c√≥
4) Update Proxy Bandwidth Settings

Enter username to update: proxy_e5f6g7h8

Update Options:
1) Update speed limit only
2) Update total quota only  
3) Update both speed limit and quota
4) Reset to unlimited    ‚Üê Ch·ªçn n√†y ƒë·ªÉ upgrade l√™n unlimited
5) Block/Unblock user

# K·∫øt qu·∫£:
‚úì User proxy_e5f6g7h8 reset to unlimited
```

### **Scenario 4: Kh√°ch h√†ng h·∫øt quota, mu·ªën gia h·∫°n**
```bash
# Reset quota cho user
9) Reset User Quota

Enter username to reset quota: proxy_e5f6g7h8
Are you sure you want to reset quota for user 'proxy_e5f6g7h8'? [y/N]: y

# K·∫øt qu·∫£:
‚úì Quota reset for user: proxy_e5f6g7h8
```

## üìä HI·ªÇN TH·ªä TH√îNG TIN CHI TI·∫æT

### **List Proxy v·ªõi Bandwidth Info**
```
Current Proxy Pairs with Bandwidth Control:

[1] User: proxy_a1b2c3d4
    HTTP:   192.168.1.100:3128:proxy_a1b2c3d4:pass_x9y8z7w6
    SOCKS5: 192.168.1.100:1080:proxy_a1b2c3d4:pass_x9y8z7w6
    Created: 2024-01-15 10:30:25 | Status: active
    Speed Limit: Unlimited
    Total Quota: Unlimited
    Usage: 2GB

[2] User: proxy_e5f6g7h8
    HTTP:   192.168.1.100:3128:proxy_e5f6g7h8:pass_m3n4o5p6
    SOCKS5: 192.168.1.100:1080:proxy_e5f6g7h8:pass_m3n4o5p6
    Created: 2024-01-15 10:30:26 | Status: blocked_quota
    Speed Limit: 100Mbps
    Total Quota: 50GB
    Usage: 50GB

[3] User: proxy_x9y8z7w6
    HTTP:   192.168.1.100:3128:proxy_x9y8z7w6:pass_q1w2e3r4
    SOCKS5: 192.168.1.100:1080:proxy_x9y8z7w6:pass_q1w2e3r4
    Created: 2024-01-15 10:30:27 | Status: active
    Speed Limit: 50Mbps
    Total Quota: Unlimited
    Usage: 1GB

Total proxy pairs: 3
```

### **Bandwidth Statistics**
```
Bandwidth Usage Statistics

Username             Speed Limit     Total Quota     Used            Status    
--------             -----------     -----------     ----            ------    
proxy_a1b2c3d4       Unlimited       Unlimited       2GB             Active    
proxy_e5f6g7h8       100Mbps         50GB            50GB            Blocked   
proxy_x9y8z7w6       50Mbps          Unlimited       1GB             Active    

Total Usage: 53GB
```

## üõ†Ô∏è C√ÄI ƒê·∫∂T V√Ä S·ª¨ D·ª§NG

### **C√†i ƒë·∫∑t Flexible Version**
```bash
# T·∫£i script flexible
wget https://raw.githubusercontent.com/your-repo/flexible-dual-proxy.sh
chmod +x flexible-dual-proxy.sh

# Ch·∫°y c√†i ƒë·∫∑t
sudo ./flexible-dual-proxy.sh
```

### **C√°c l·ªánh qu·∫£n l√Ω**
```bash
# V√†o menu qu·∫£n l√Ω
sudo ./flexible-dual-proxy.sh menu

# Xem th√¥ng tin c√†i ƒë·∫∑t
sudo ./flexible-dual-proxy.sh info

# Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•
sudo ./flexible-dual-proxy.sh status

# Xem th·ªëng k√™ bandwidth
sudo ./flexible-dual-proxy.sh stats
```

## üéØ USE CASES CHO KINH DOANH

### **G√≥i Free/Trial**
- **Speed**: Unlimited
- **Quota**: Unlimited
- **Price**: Free
- **Note**: ƒê·ªÉ kh√°ch h√†ng test

### **G√≥i Basic**
- **Speed**: 50Mbps
- **Quota**: 20GB total
- **Price**: $5 one-time
- **Note**: H·∫øt quota th√¨ mua th√™m

### **G√≥i Premium**
- **Speed**: 100Mbps
- **Quota**: Unlimited
- **Price**: $15 one-time
- **Note**: Ch·ªâ gi·ªõi h·∫°n t·ªëc ƒë·ªô

### **G√≥i Enterprise**
- **Speed**: Unlimited
- **Quota**: Unlimited
- **Price**: $30 one-time
- **Note**: Kh√¥ng gi·ªõi h·∫°n g√¨

### **Qu·∫£n l√Ω linh ho·∫°t**
```bash
# Kh√°ch h√†ng mua g√≥i Basic
create_proxy_pair
# -> Ch·ªçn custom: 50Mbps, 20GB

# Kh√°ch h√†ng h·∫øt quota, mu·ªën mua th√™m
reset_user_quota
# -> Reset quota v·ªÅ 0, kh√°ch d√πng ti·∫øp

# Kh√°ch h√†ng mu·ªën upgrade l√™n Premium
update_proxy_bandwidth
# -> Ch·ªçn option 3: Set 100Mbps, Unlimited quota

# Kh√°ch h√†ng mu·ªën downgrade
update_proxy_bandwidth
# -> Ch·ªçn option 3: Set 50Mbps, 10GB quota

# T·∫°m d·ª´ng d·ªãch v·ª• kh√°ch h√†ng
update_proxy_bandwidth
# -> Ch·ªçn option 5: Block user
```

## üîç TECHNICAL IMPLEMENTATION

### **Database Structure**
```bash
# /etc/proxy-manager/proxy_users.db
# Format: USERNAME:PASSWORD:CREATED_DATE:STATUS:SPEED_LIMIT_MBPS:TOTAL_QUOTA_GB:USED_BYTES

proxy_a1b2c3d4:pass_x9y8z7w6:2024-01-15 10:30:25:active:0:0:2147483648
proxy_e5f6g7h8:pass_m3n4o5p6:2024-01-15 10:30:26:blocked_quota:100:50:53687091200
proxy_x9y8z7w6:pass_q1w2e3r4:2024-01-15 10:30:27:active:50:0:1073741824

# Gi·∫£i th√≠ch:
# SPEED_LIMIT_MBPS: 0 = Unlimited
# TOTAL_QUOTA_GB: 0 = Unlimited
# USED_BYTES: T·ªïng bytes ƒë√£ s·ª≠ d·ª•ng
```

### **Traffic Control Implementation**
```bash
# T·∫°o HTB qdisc
tc qdisc add dev eth0 root handle 1: htb default 999

# Class ch√≠nh (1000Mbps ceiling)
tc class add dev eth0 parent 1: classid 1:1 htb rate 1000mbit

# Class cho user c√≥ gi·ªõi h·∫°n (v√≠ d·ª•: 100Mbps)
tc class add dev eth0 parent 1:1 classid 1:1001 htb rate 100mbit ceil 100mbit

# Filter traffic theo UID
tc filter add dev eth0 protocol ip parent 1:0 prio 1 handle 1001 fw flowid 1:1001

# Mark packets v·ªõi iptables
iptables -t mangle -A OUTPUT -m owner --uid-owner 1001 -j MARK --set-mark 1001
```

### **Quota Management**
```bash
# Monitoring script ch·∫°y m·ªói 5 ph√∫t
*/5 * * * * root /usr/local/bin/proxy-bandwidth-monitor.sh

# Parse Squid logs ƒë·ªÉ t√≠nh usage
awk -v user="username" '$8 == user {total += ($5 + $6)} END {print total}' /var/log/squid/access.log

# Block user khi h·∫øt quota
iptables -I OUTPUT -m owner --uid-owner $uid -j DROP

# Update status trong database
sed -i "s/:active:/:blocked_quota:/" proxy_users.db
```

## üîß TROUBLESHOOTING

### **Ki·ªÉm tra Traffic Control**
```bash
# Xem qdisc hi·ªán t·∫°i
sudo tc qdisc show dev eth0

# Xem classes v·ªõi statistics
sudo tc -s class show dev eth0

# Xem filters
sudo tc filter show dev eth0
```

### **Ki·ªÉm tra User Status**
```bash
# Xem user b·ªã block
sudo grep "blocked_quota" /etc/proxy-manager/proxy_users.db

# Xem usage c·ªßa user
sudo grep "proxy_a1b2c3d4" /etc/proxy-manager/proxy_users.db

# Test connection t·ª´ user
sudo -u proxy_a1b2c3d4 curl -s --max-time 5 http://ifconfig.me
```

### **Debug Bandwidth Monitoring**
```bash
# Ch·∫°y monitor script th·ªß c√¥ng
sudo /usr/local/bin/proxy-bandwidth-monitor.sh

# Xem log
sudo tail -f /var/log/proxy-bandwidth-monitor.log

# Test quota check
username="proxy_a1b2c3d4"
used_bytes=$(awk -v user="$username" '$8 == user {total += ($5 + $6)} END {print total+0}' /var/log/squid/access.log)
echo "User $username used: $((used_bytes / 1024 / 1024)) MB"
```

## üìà PERFORMANCE OPTIMIZATION

### **System Tuning**
```bash
# TƒÉng file descriptor limits
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# Optimize network stack
echo 'net.core.rmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 134217728' >> /etc/sysctl.conf
sysctl -p
```

### **Squid Optimization**
```bash
# TƒÉng cache memory
cache_mem 1024 MB

# TƒÉng maximum object size  
maximum_object_size 512 MB
```

## üéâ K·∫æT LU·∫¨N

**Flexible Dual Proxy Manager v4.0** l√† gi·∫£i ph√°p ho√†n h·∫£o cho tri·∫øt l√Ω **"Th√≠ch th√¨ gi·ªõi h·∫°n th√¥i!"**:

### ‚úÖ **ƒê·∫£m b·∫£o 100%**
- **M·∫∑c ƒë·ªãnh UNLIMITED** cho t·∫•t c·∫£ proxy m·ªõi
- **Gi·ªõi h·∫°n KHI C·∫¶N** - kh√¥ng b·∫Øt bu·ªôc
- **Thay ƒë·ªïi b·∫•t c·ª© l√∫c n√†o** - linh ho·∫°t ho√†n to√†n
- **Kh√¥ng theo th√°ng** - t·ª± do qu·∫£n l√Ω quota
- **Real-time control** - thay ƒë·ªïi t·ª©c th√¨

### üöÄ **Ph√π h·ª£p cho**
- **Kinh doanh proxy** linh ho·∫°t
- **Kh√¥ng mu·ªën r√†ng bu·ªôc** theo th√°ng
- **Qu·∫£n l√Ω ƒë∆°n gi·∫£n** v√† th·ª±c t·∫ø
- **Kh√°ch h√†ng ƒëa d·∫°ng** nhu c·∫ßu

### üí° **Unique Features**
- **On-demand bandwidth control** - ch·ªâ khi c·∫ßn
- **No monthly restrictions** - kh√¥ng r√†ng bu·ªôc th·ªùi gian
- **Instant changes** - thay ƒë·ªïi t·ª©c th√¨
- **Business flexibility** - linh ho·∫°t kinh doanh
- **Simple management** - qu·∫£n l√Ω ƒë∆°n gi·∫£n

---

**üî• ƒê·∫∑c bi·ªát**: Script n√†y l√† phi√™n b·∫£n duy nh·∫•t c√≥ **BANDWIDTH CONTROL LINH HO·∫†T** - gi·ªõi h·∫°n khi mu·ªën, kh√¥ng b·∫Øt bu·ªôc theo th√°ng nh∆∞ b·∫°n y√™u c·∫ßu!